<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Deck of Gains Tests</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 32px clamp(16px, 5vw, 32px);
        padding-top: calc(env(safe-area-inset-top, 0px) + 32px);
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 32px);
        background: #f5f5f5;
      }
      #test-results {
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .test-pass {
        color: #0a7f00;
      }
      .test-fail {
        color: #b00020;
      }
      pre {
        background: #272822;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
      }
      #app {
        display: none;
      }
      #configuration-screen {
        max-width: 420px;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }
      #configuration-screen form {
        display: grid;
        gap: 0.75rem;
      }
      .configuration-row {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        align-items: center;
      }
    </style>
  </head>
  <body onload="initializeApp()">
    <div id="configuration-screen" style="display: flex;">
      <h1>Deck of Gains</h1>
      <form id="configuration-form">
        <div class="configuration-row">
          <label for="multiplier-hearts">Hearts Multiplier</label>
          <select id="multiplier-hearts">
            <option value="1">1×</option>
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
        </div>
        <div class="configuration-row">
          <label for="multiplier-spades">Spades Multiplier</label>
          <select id="multiplier-spades">
            <option value="1">1×</option>
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
        </div>
        <div class="configuration-row">
          <label for="multiplier-diamonds">Diamonds Multiplier</label>
          <select id="multiplier-diamonds">
            <option value="1">1×</option>
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
        </div>
        <div class="configuration-row">
          <label for="multiplier-clubs">Clubs Multiplier</label>
          <select id="multiplier-clubs">
            <option value="1">1×</option>
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
        </div>
        <div class="configuration-row">
          <label>
            <input type="radio" name="theme" value="casino" checked>
            Casino Theme
          </label>
          <label>
            <input type="radio" name="theme" value="rugged">
            Rugged Theme
          </label>
        </div>
        <button type="button" id="start-workout" onclick="startWorkout()">Start Workout</button>
      </form>
    </div>

    <div id="app" style="display: none;">
      <h1 id="round-title">Deck of Gains</h1>
      <div id="drawn-cards"></div>
      <button id="draw-button" onclick="drawCards()">Draw Cards</button>
      <div id="instructions"></div>
    </div>

    <section id="test-results">
      <h1>Deck of Gains Browser Test Suite</h1>
      <ul id="results-list"></ul>
      <pre id="summary"></pre>
    </section>

    <script src="app.js"></script>
    <script>
      (function () {
        const resultsList = document.getElementById('results-list');
        const summary = document.getElementById('summary');
        let passed = 0;
        let failed = 0;

        function logResult(message, isPass) {
          const item = document.createElement('li');
          item.textContent = message;
          item.className = isPass ? 'test-pass' : 'test-fail';
          resultsList.appendChild(item);
        }

        function expect(condition, message) {
          if (!condition) {
            throw new Error(message);
          }
        }

        function test(name, fn) {
          try {
            fn();
            passed += 1;
            logResult(`✔️ ${name}`, true);
          } catch (error) {
            failed += 1;
            logResult(`❌ ${name}: ${error.message}`, false);
          }
        }

        function resetAppDOM() {
          document.getElementById('drawn-cards').innerHTML = '';
          const instructions = document.getElementById('instructions');
          instructions.innerHTML = '';
          const drawButton = document.getElementById('draw-button');
          drawButton.style.display = '';
          roundCompleted = false;
        }

        function startWorkoutWithOptions({ theme, multipliers } = {}) {
          if (multipliers) {
            Object.entries(multipliers).forEach(([suit, value]) => {
              const select = document.getElementById(`multiplier-${suit}`);
              if (select) {
                select.value = String(value);
              }
            });
          }

          if (theme) {
            const themeInput = document.querySelector(`input[name="theme"][value="${theme}"]`);
            if (themeInput) {
              themeInput.checked = true;
            }
          }

          if (typeof startWorkout === 'function') {
            startWorkout();
          }
        }

        function withPatchedRandom(value, callback) {
          const originalRandom = Math.random;
          Math.random = () => value;
          try {
            return callback();
          } finally {
            Math.random = originalRandom;
          }
        }

        function buildCards(cards) {
          deck = cards.map(card => ({ ...card }));
        }

        function cardKey(card) {
          return `${card.suit}-${card.number}`;
        }

        function parsePixels(value) {
          if (typeof value !== 'string') {
            return 0;
          }
          const match = value.match(/([0-9.]+)px/);
          return match ? parseFloat(match[1]) : 0;
        }

        function runTests() {
          test('configuration screen is shown on load', () => {
            const configurationScreen = document.getElementById('configuration-screen');
            expect(configurationScreen && configurationScreen.style.display !== 'none', 'Configuration screen should be visible on load');
            const appContainer = document.getElementById('app');
            expect(appContainer && appContainer.style.display === 'none', 'Workout area should be hidden until the workout starts');
          });

          test('default multipliers start at 1× except clubs at 2×', () => {
            const heartsSelect = document.getElementById('multiplier-hearts');
            expect(heartsSelect && heartsSelect.value === '1', 'Hearts default multiplier should be 1×');

            const spadesSelect = document.getElementById('multiplier-spades');
            expect(spadesSelect && spadesSelect.value === '1', 'Spades default multiplier should be 1×');

            const diamondsSelect = document.getElementById('multiplier-diamonds');
            expect(diamondsSelect && diamondsSelect.value === '1', 'Diamonds default multiplier should be 1×');

            const clubsSelect = document.getElementById('multiplier-clubs');
            expect(clubsSelect && clubsSelect.value === '2', 'Clubs default multiplier should remain 2×');
          });

          test('initializeDeck creates a 52 card deck with unique cards', () => {
            initializeDeck();
            expect(deck.length === 52, 'Deck should contain 52 cards');
            const uniqueCards = new Set(deck.map(cardKey));
            expect(uniqueCards.size === 52, 'Each card in the deck should be unique');
          });

          test('getCardDisplayValue formats face cards and aces correctly', () => {
            expect(getCardDisplayValue(1) === 'A', 'Ace should display as A');
            expect(getCardDisplayValue(11) === 'J', 'Jack should display as J');
            expect(getCardDisplayValue(12) === 'Q', 'Queen should display as Q');
            expect(getCardDisplayValue(13) === 'K', 'King should display as K');
            expect(getCardDisplayValue(7) === 7, 'Number cards should display their number');
          });

          test('getCardValue applies scoring rules for face cards and aces', () => {
            expect(getCardValue(12) === 10, 'Face cards should be worth 10');
            expect(getCardValue(1) === 11, 'Ace should be worth 11');
            expect(getCardValue(7) === 7, 'Number cards should be worth their number');
          });

          test('startWorkout applies theme selection and hides the configuration screen', () => {
            startWorkoutWithOptions({ theme: 'rugged', multipliers: { hearts: 2, spades: 2, diamonds: 2, clubs: 2 } });

            const configurationScreen = document.getElementById('configuration-screen');
            expect(configurationScreen && configurationScreen.style.display === 'none', 'Configuration screen should be hidden after starting the workout');
            const appContainer = document.getElementById('app');
            expect(appContainer && appContainer.style.display !== 'none', 'Workout area should be visible after starting the workout');
            expect(document.body.classList.contains('rugged'), 'Selected theme should be applied to the body');
          });

          test('changing the theme radio buttons applies the theme immediately', () => {
            const ruggedRadio = document.querySelector('input[name="theme"][value="rugged"]');
            const casinoRadio = document.querySelector('input[name="theme"][value="casino"]');

            expect(ruggedRadio, 'Rugged theme radio should be present');
            expect(casinoRadio, 'Casino theme radio should be present');

            ruggedRadio.checked = true;
            ruggedRadio.dispatchEvent(new Event('change', { bubbles: true }));
            expect(document.body.classList.contains('rugged'), 'Switching to the rugged option should apply the rugged theme');

            casinoRadio.checked = true;
            casinoRadio.dispatchEvent(new Event('change', { bubbles: true }));
            expect(!document.body.classList.contains('rugged'), 'Switching back to the casino option should remove the rugged theme');
          });

          test('configuration screen layout leaves space for mobile safe areas', () => {
            const bodyStyles = window.getComputedStyle(document.body);
            const topPadding = parsePixels(bodyStyles.paddingTop);
            const bottomPadding = parsePixels(bodyStyles.paddingBottom);

            expect(
              topPadding >= 16,
              `Body should include top padding to avoid clipping under mobile safe areas (raw: ${bodyStyles.paddingTop})`
            );
            expect(
              bottomPadding >= 16,
              `Body should include bottom padding to avoid clipping under mobile safe areas (raw: ${bodyStyles.paddingBottom})`
            );
          });

          test('doDrawCards removes four cards when more than eight remain', () => {
            roundCompleted = false;
            buildCards([
              { suit: 'hearts', number: 1 },
              { suit: 'spades', number: 12 },
              { suit: 'diamonds', number: 5 },
              { suit: 'clubs', number: 3 },
              { suit: 'diamonds', number: 13 },
              { suit: 'clubs', number: 4 },
              { suit: 'spades', number: 2 },
              { suit: 'hearts', number: 7 },
              { suit: 'clubs', number: 11 }
            ]);

            const drawn = withPatchedRandom(0, () => doDrawCards());
            expect(drawn.length === 4, 'Exactly four cards should be drawn');
            expect(deck.length === 5, 'Deck should retain the remaining cards');
            const expected = [
              'hearts-1',
              'spades-12',
              'diamonds-5',
              'clubs-3'
            ];
            expect(drawn.map(cardKey).join('|') === expected.join('|'), 'Cards should be drawn in predictable order when random is patched');
          });

          test('doDrawCards draws the remainder when eight or fewer cards remain', () => {
            roundCompleted = true;
            buildCards([
              { suit: 'hearts', number: 2 },
              { suit: 'spades', number: 3 },
              { suit: 'diamonds', number: 4 },
              { suit: 'clubs', number: 5 },
              { suit: 'hearts', number: 6 },
              { suit: 'spades', number: 7 },
              { suit: 'diamonds', number: 8 },
              { suit: 'clubs', number: 9 }
            ]);

            const drawn = withPatchedRandom(0, () => doDrawCards());
            expect(drawn.length === 8, 'All remaining cards should be drawn');
            expect(deck.length === 0, 'Deck should be empty after drawing all remaining cards');
          });

          test('drawCards updates the DOM and workout instructions', () => {
            resetAppDOM();
            startWorkoutWithOptions({ theme: 'casino', multipliers: { hearts: 2, spades: 2, diamonds: 2, clubs: 2 } });
            buildCards([
              { suit: 'hearts', number: 1 },
              { suit: 'spades', number: 12 },
              { suit: 'diamonds', number: 5 },
              { suit: 'clubs', number: 3 },
              { suit: 'diamonds', number: 13 },
              { suit: 'clubs', number: 4 },
              { suit: 'spades', number: 2 },
              { suit: 'hearts', number: 7 },
              { suit: 'clubs', number: 11 }
            ]);

            withPatchedRandom(0, () => drawCards());

            const roundTitle = document.getElementById('round-title');
            expect(roundTitle.textContent === 'Round 1 of 12', 'Round title should show the current round');
            const drawnCards = document.getElementById('drawn-cards');
            expect(drawnCards.children.length === 4, 'Exactly four card elements should be rendered');
            const instructions = document.getElementById('instructions');
            expect(
              instructions.children[0].textContent === 'Jumping Jacks: 22 reps | Squats: 20 reps | Pushups: 10 reps | Abs: 6 reps',
              'Instructions should summarize the reps for drawn cards'
            );
            expect(
              instructions.children[1].textContent === 'Complete a 50 yard sprint.',
              'A sprint reminder should be shown when cards remain in the deck'
            );
            expect(deck.length === 5, 'Deck should have five cards remaining');
            expect(roundCompleted === true, 'Round should be marked as completed');
            expect(roundNumber === 2, 'Next round number should be prepared');
            expect(document.getElementById('draw-button').style.display !== 'none', 'Draw button should remain visible when cards remain');
          });

          test('configured multipliers adjust the workout totals', () => {
            resetAppDOM();
            startWorkoutWithOptions({
              theme: 'casino',
              multipliers: { hearts: 2, spades: 3, diamonds: 4, clubs: 4 }
            });

            buildCards([
              { suit: 'hearts', number: 6 },
              { suit: 'spades', number: 7 },
              { suit: 'diamonds', number: 8 },
              { suit: 'clubs', number: 9 }
            ]);

            withPatchedRandom(0, () => drawCards());

            const instructions = document.getElementById('instructions');
            expect(
              instructions.children[0].textContent === 'Jumping Jacks: 12 reps | Squats: 21 reps | Pushups: 32 reps | Abs: 36 reps',
              'Configured multipliers should be applied to each suit'
            );
          });

          test('drawCards handles the final draw and sprint instructions', () => {
            resetAppDOM();
            startWorkoutWithOptions({ theme: 'casino', multipliers: { hearts: 2, spades: 2, diamonds: 2, clubs: 2 } });
            roundNumber = 11;
            buildCards([
              { suit: 'hearts', number: 2 },
              { suit: 'spades', number: 3 },
              { suit: 'diamonds', number: 4 },
              { suit: 'clubs', number: 5 }
            ]);

            withPatchedRandom(0, () => drawCards());

            expect(deck.length === 0, 'Deck should be empty after the final draw');
            const instructions = document.getElementById('instructions');
            expect(
              instructions.children[0].textContent === 'Jumping Jacks: 4 reps | Squats: 6 reps | Pushups: 8 reps | Abs: 10 reps',
              'Instructions should summarize all reps for the final draw'
            );
            expect(
              instructions.children[1].textContent === 'Complete 2 sprints of 50 yards each.',
              'Two sprint reminder should be shown when the deck is depleted'
            );
            const newSetButton = instructions.querySelector('button');
            expect(newSetButton && newSetButton.textContent === 'New Set', 'A New Set button should be presented when the deck is depleted');
            expect(document.getElementById('draw-button').style.display === 'none', 'Draw button should be hidden when the deck is depleted');
          });

          summary.textContent = `Tests Passed: ${passed}\nTests Failed: ${failed}`;
        }

        window.addEventListener('load', runTests);
      })();
    </script>
  </body>
</html>
